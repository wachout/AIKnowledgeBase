# ç»Ÿè®¡æŒ‡æ ‡æ•°æ®é‡è¿‡å¤§é—®é¢˜ä¿®å¤

## ğŸš¨ é—®é¢˜æè¿°

åœ¨è°ƒç”¨ EChartsAgent ç”Ÿæˆå›¾è¡¨æ—¶ï¼Œå‡ºç°é”™è¯¯ï¼š
```
Error code: 400 - {'error': {'message': 'Exceeded limit on max bytes to request body : 6291456', ...}}
```

**é—®é¢˜åŸå› **ï¼š
- æ­¥éª¤4ï¼ˆæ•°ç†ç»Ÿè®¡æ™ºèƒ½ä½“ï¼‰è¿”å›çš„ç»Ÿè®¡æŒ‡æ ‡åŒ…å«äº†å®Œæ•´çš„æ•°æ®ç»“æ„
- ç‰¹åˆ«æ˜¯ `correlation_matrix`ï¼ˆç›¸å…³æ€§çŸ©é˜µï¼‰å¯èƒ½éå¸¸å¤§ï¼ˆNÃ—NçŸ©é˜µï¼‰
- å®Œæ•´çš„ `frequency` å­—å…¸ä¹Ÿå¯èƒ½åŒ…å«å¤§é‡æ•°æ®
- æ­¥éª¤8å°†è¿™äº›å®Œæ•´æ•°æ®ä¼ é€’ç»™ EChartsAgentï¼Œå¯¼è‡´æ•°æ®é‡è¶…è¿‡6MBé™åˆ¶

## ğŸ” æ ¹æœ¬åŸå› åˆ†æ

### 1. **ç›¸å…³æ€§çŸ©é˜µè¿‡å¤§**

`StatisticsCalculator.calculate_all_statistics()` è¿”å›ï¼š
```python
{
    "correlation_analysis": {
        "correlation_matrix": corr_matrix.to_dict(),  # âš ï¸ å®Œæ•´çŸ©é˜µï¼Œå¯èƒ½éå¸¸å¤§
        "strong_correlations": [...]
    }
}
```

**é—®é¢˜**ï¼š
- å¦‚æœæœ‰100åˆ—ï¼Œç›¸å…³æ€§çŸ©é˜µå°±æ˜¯100Ã—100=10,000ä¸ªå€¼
- æ¯ä¸ªå€¼éƒ½æ˜¯æµ®ç‚¹æ•°ï¼ŒJSONåºåˆ—åŒ–åå¯èƒ½è¾¾åˆ°å‡ MB

### 2. **é¢‘ç‡åˆ†å¸ƒè¿‡å¤§**

```python
{
    "frequency_analysis": {
        "col1": {
            "frequency": value_counts.to_dict(),  # âš ï¸ å®Œæ•´çš„é¢‘ç‡åˆ†å¸ƒï¼Œå¯èƒ½åŒ…å«æ•°åƒä¸ªå€¼
            "top_10": {...}
        }
    }
}
```

**é—®é¢˜**ï¼š
- å¦‚æœæŸä¸ªåˆ—æœ‰æ•°åƒä¸ªå”¯ä¸€å€¼ï¼Œå®Œæ•´çš„é¢‘ç‡åˆ†å¸ƒå­—å…¸ä¼šéå¸¸å¤§

### 3. **æ•°æ®ä¼ é€’é—®é¢˜**

æ­¥éª¤8ç›´æ¥å°†å®Œæ•´çš„ `statistics_result` åºåˆ—åŒ–åä¼ é€’ç»™ EChartsAgentï¼š
```python
data_str = json.dumps(statistics_result, ensure_ascii=False, default=str)
echarts_result = echarts_agent.generate_echarts_config(data_str, query)
```

**é—®é¢˜**ï¼š
- åŒ…å«äº†æ‰€æœ‰æ•°æ®ï¼ŒåŒ…æ‹¬å®Œæ•´çŸ©é˜µå’Œå®Œæ•´é¢‘ç‡åˆ†å¸ƒ
- æ•°æ®é‡å¯èƒ½è¶…è¿‡6MBé™åˆ¶

## âœ… è§£å†³æ–¹æ¡ˆ

### 1. **åˆ›å»º `_extract_chart_indicators` å‡½æ•°**

**ä½ç½®**: `src/Agent/TableFileAgent/file_analysis_agent.py`

**åŠŸèƒ½**ï¼š
- ä»å®Œæ•´çš„ç»Ÿè®¡ç»“æœä¸­æå–ç”¨äºç”Ÿæˆå›¾è¡¨çš„å…³é”®æŒ‡æ ‡
- **ä¸åŒ…å«**å®Œæ•´çš„ç›¸å…³æ€§çŸ©é˜µã€å®Œæ•´é¢‘ç‡åˆ†å¸ƒç­‰å¤§æ•°æ®
- åªä¿ç•™å¿…è¦çš„ç»Ÿè®¡æŒ‡æ ‡

**ç²¾ç®€ç­–ç•¥**ï¼š
- **æè¿°æ€§ç»Ÿè®¡**ï¼šåªä¿ç•™å…³é”®æŒ‡æ ‡ï¼ˆmean, median, std, min, maxç­‰ï¼‰ï¼Œåªä¿ç•™å‰20åˆ—
- **ç›¸å…³æ€§åˆ†æ**ï¼š**ä¸åŒ…å«** `correlation_matrix`ï¼Œåªä¿ç•™ `strong_correlations`ï¼ˆå‰20ä¸ªï¼‰
- **é¢‘ç‡åˆ†æ**ï¼š**ä¸åŒ…å«**å®Œæ•´çš„ `frequency` å­—å…¸ï¼Œåªä¿ç•™ `top_10`ï¼Œåªä¿ç•™å‰10åˆ—
- **åˆ†å¸ƒåˆ†æ**ï¼šåªä¿ç•™å…³é”®æŒ‡æ ‡ï¼ˆskewness, kurtosis, distribution_typeï¼‰ï¼Œåªä¿ç•™å‰10åˆ—

### 2. **ä¿®æ”¹æ­¥éª¤8çš„æ•°æ®ä¼ é€’**

**ä¿®æ”¹å‰**ï¼š
```python
data_str = json.dumps(statistics_result, ...)  # åŒ…å«å®Œæ•´æ•°æ®
```

**ä¿®æ”¹å**ï¼š
```python
# æå–ç”¨äºç”Ÿæˆå›¾è¡¨çš„å…³é”®æŒ‡æ ‡
chart_indicators = _extract_chart_indicators(statistics_result)
data_str = json.dumps(chart_indicators, ...)  # åªåŒ…å«ç²¾ç®€åçš„æŒ‡æ ‡
```

### 3. **ä¿®æ”¹æ­¥éª¤4çš„æŒ‡æ ‡ç²¾ç®€**

**ä½ç½®**: `src/Agent/TableFileAgent/statistics_calculation_agent.py`

**æ”¹è¿›**ï¼š
- `_simplify_indicators()` æ–¹æ³•ç¡®ä¿ä¸åŒ…å«å®Œæ•´çŸ©é˜µ
- åœ¨ç”Ÿæˆ ECharts ç»“æ„å‰å°±è¿›è¡Œç²¾ç®€
- å¦‚æœä»ç„¶å¤ªå¤§ï¼Œè¿›ä¸€æ­¥ç²¾ç®€

## ğŸ“Š æ•°æ®ç²¾ç®€å¯¹æ¯”

### ç²¾ç®€å‰ï¼ˆå¯èƒ½è¶…è¿‡6MBï¼‰ï¼š

```python
{
    "calculations": {
        "Sheet1": {
            "correlation_analysis": {
                "correlation_matrix": {
                    "col1": {"col1": 1.0, "col2": 0.85, ..., "col100": 0.23},  # 100ä¸ªå€¼
                    "col2": {"col1": 0.85, "col2": 1.0, ..., "col100": 0.45},  # 100ä¸ªå€¼
                    ...  # 100è¡Œ
                },  # æ€»å…±10,000ä¸ªå€¼
                "strong_correlations": [...]
            },
            "frequency_analysis": {
                "col1": {
                    "frequency": {"value1": 1000, "value2": 950, ..., "value5000": 1},  # 5000ä¸ªå€¼
                    "top_10": {...}
                }
            }
        }
    }
}
```

### ç²¾ç®€åï¼ˆé€šå¸¸<100KBï¼‰ï¼š

```python
{
    "calculations": {
        "Sheet1": {
            "correlation_analysis": {
                "strong_correlations": [
                    {"column1": "col1", "column2": "col2", "correlation": 0.85},
                    ...  # æœ€å¤š20ä¸ª
                ]
                # ä¸åŒ…å« correlation_matrix
            },
            "frequency_analysis": {
                "col1": {
                    "unique_count": 5000,
                    "top_10": {"value1": 1000, "value2": 950, ...}  # åªæœ‰10ä¸ªå€¼
                    # ä¸åŒ…å«å®Œæ•´çš„ frequency å­—å…¸
                }
            }
        }
    }
}
```

## ğŸ¯ å…³é”®æ”¹è¿›ç‚¹

### 1. **ä¸åŒ…å«ç›¸å…³æ€§çŸ©é˜µ**

**åŸå› **ï¼š
- ç›¸å…³æ€§çŸ©é˜µæ˜¯ NÃ—N çŸ©é˜µï¼Œæ•°æ®é‡å·¨å¤§
- ç”Ÿæˆå›¾è¡¨æ—¶åªéœ€è¦å¼ºç›¸å…³å…³ç³»ï¼Œä¸éœ€è¦å®Œæ•´çŸ©é˜µ

**å¤„ç†**ï¼š
```python
# ä¸åŒ…å« correlation_matrix
simplified_corr = {
    "strong_correlations": corr_analysis.get("strong_correlations", [])[:20]
    # ä¸åŒ…å« correlation_matrix
}
```

### 2. **ä¸åŒ…å«å®Œæ•´é¢‘ç‡åˆ†å¸ƒ**

**åŸå› **ï¼š
- å®Œæ•´çš„é¢‘ç‡åˆ†å¸ƒå¯èƒ½åŒ…å«æ•°åƒä¸ªå€¼
- ç”Ÿæˆå›¾è¡¨æ—¶åªéœ€è¦ top_10ï¼Œä¸éœ€è¦å®Œæ•´åˆ†å¸ƒ

**å¤„ç†**ï¼š
```python
simplified_freq[col_name] = {
    "unique_count": freq.get("unique_count"),
    "top_10": freq.get("top_10", {})  # åªä¿ç•™ top_10
    # ä¸åŒ…å«å®Œæ•´çš„ frequency å­—å…¸
}
```

### 3. **é™åˆ¶åˆ—æ•°**

**åŸå› **ï¼š
- å¦‚æœæœ‰å¾ˆå¤šåˆ—ï¼Œå³ä½¿æ¯åˆ—æ•°æ®ä¸å¤§ï¼Œæ€»æ•°æ®é‡ä¹Ÿä¼šå¾ˆå¤§
- ç”Ÿæˆå›¾è¡¨æ—¶é€šå¸¸ä¸éœ€è¦æ‰€æœ‰åˆ—

**å¤„ç†**ï¼š
- æè¿°æ€§ç»Ÿè®¡ï¼šåªä¿ç•™å‰20åˆ—
- é¢‘ç‡åˆ†æï¼šåªä¿ç•™å‰10åˆ—
- åˆ†å¸ƒåˆ†æï¼šåªä¿ç•™å‰10åˆ—

### 4. **é™åˆ¶å¼ºç›¸å…³å…³ç³»æ•°é‡**

**åŸå› **ï¼š
- å¼ºç›¸å…³å…³ç³»åˆ—è¡¨å¯èƒ½å¾ˆé•¿
- ç”Ÿæˆå›¾è¡¨æ—¶åªéœ€è¦æœ€é‡è¦çš„å‡ ä¸ª

**å¤„ç†**ï¼š
- åªä¿ç•™å‰20ä¸ªå¼ºç›¸å…³å…³ç³»

## ğŸ“ ä»£ç ä¿®æ”¹ä½ç½®

### 1. æ–°å¢å‡½æ•° `_extract_chart_indicators`

**æ–‡ä»¶**: `src/Agent/TableFileAgent/file_analysis_agent.py`
**ä½ç½®**: ç¬¬64-140è¡Œï¼ˆåœ¨ `_convert_to_json_serializable` ä¹‹åï¼‰

### 2. ä¿®æ”¹æ­¥éª¤8çš„æ•°æ®ä¼ é€’

**æ–‡ä»¶**: `src/Agent/TableFileAgent/file_analysis_agent.py`
**ä½ç½®**: ç¬¬535-570è¡Œ
**ä¿®æ”¹**ï¼š
- ä½¿ç”¨ `_extract_chart_indicators()` æå–å…³é”®æŒ‡æ ‡
- æ•°æ®å¤§å°é™åˆ¶ä»100KBé™ä½åˆ°50KB
- å¦‚æœä»ç„¶å¤ªå¤§ï¼Œè¿›ä¸€æ­¥ç²¾ç®€

### 3. ä¿®æ”¹æ­¥éª¤4çš„æŒ‡æ ‡ç²¾ç®€

**æ–‡ä»¶**: `src/Agent/TableFileAgent/statistics_calculation_agent.py`
**ä½ç½®**: 
- `_simplify_indicators()` æ–¹æ³•ï¼ˆç¬¬251-290è¡Œï¼‰
- `_generate_echarts_from_indicators()` æ–¹æ³•ï¼ˆç¬¬180-250è¡Œï¼‰

**ä¿®æ”¹**ï¼š
- ç¡®ä¿ä¸åŒ…å« `correlation_matrix`
- ç¡®ä¿ä¸åŒ…å«å®Œæ•´çš„ `frequency` å­—å…¸
- é™åˆ¶åˆ—æ•°å’Œæ•°æ®é‡

## ğŸ” æ•°æ®å¤§å°ä¼°ç®—

### ç›¸å…³æ€§çŸ©é˜µå¤§å°ï¼š

å‡è®¾æœ‰ N åˆ—ï¼š
- çŸ©é˜µå¤§å°ï¼šN Ã— N
- æ¯ä¸ªå€¼ï¼šçº¦10-15å­—ç¬¦ï¼ˆåŒ…æ‹¬é”®åå’Œå€¼ï¼‰
- æ€»å¤§å°ï¼šN Ã— N Ã— 15 å­—ç¬¦

**ç¤ºä¾‹**ï¼š
- 50åˆ—ï¼š50 Ã— 50 Ã— 15 = 37,500 å­—ç¬¦ â‰ˆ 37KB
- 100åˆ—ï¼š100 Ã— 100 Ã— 15 = 150,000 å­—ç¬¦ â‰ˆ 150KB
- 200åˆ—ï¼š200 Ã— 200 Ã— 15 = 600,000 å­—ç¬¦ â‰ˆ 600KB
- 500åˆ—ï¼š500 Ã— 500 Ã— 15 = 3,750,000 å­—ç¬¦ â‰ˆ 3.75MB

### é¢‘ç‡åˆ†å¸ƒå¤§å°ï¼š

å‡è®¾æŸåˆ—æœ‰ M ä¸ªå”¯ä¸€å€¼ï¼š
- æ¯ä¸ªå€¼ï¼šçº¦20-30å­—ç¬¦ï¼ˆåŒ…æ‹¬é”®åå’Œå€¼ï¼‰
- æ€»å¤§å°ï¼šM Ã— 25 å­—ç¬¦

**ç¤ºä¾‹**ï¼š
- 1000ä¸ªå”¯ä¸€å€¼ï¼š1000 Ã— 25 = 25,000 å­—ç¬¦ â‰ˆ 25KB
- 5000ä¸ªå”¯ä¸€å€¼ï¼š5000 Ã— 25 = 125,000 å­—ç¬¦ â‰ˆ 125KB

### ç²¾ç®€åçš„æ•°æ®å¤§å°ï¼š

- æè¿°æ€§ç»Ÿè®¡ï¼ˆ20åˆ—ï¼‰ï¼š20 Ã— 10 Ã— 15 = 3,000 å­—ç¬¦ â‰ˆ 3KB
- å¼ºç›¸å…³å…³ç³»ï¼ˆ20ä¸ªï¼‰ï¼š20 Ã— 50 = 1,000 å­—ç¬¦ â‰ˆ 1KB
- é¢‘ç‡åˆ†æï¼ˆ10åˆ—ï¼Œæ¯åˆ—top_10ï¼‰ï¼š10 Ã— 10 Ã— 20 = 2,000 å­—ç¬¦ â‰ˆ 2KB
- **æ€»è®¡**ï¼šçº¦6-10KBï¼ˆè¿œå°äº6MBé™åˆ¶ï¼‰

## âœ… éªŒè¯æ–¹æ³•

1. **æ£€æŸ¥æ•°æ®å¤§å°**ï¼š
   ```python
   data_str = json.dumps(chart_indicators, ...)
   logger.info(f"ğŸ“Š å›¾è¡¨æŒ‡æ ‡é•¿åº¦: {len(data_str)} å­—ç¬¦")
   ```

2. **é¢„æœŸç»“æœ**ï¼š
   - ç²¾ç®€åçš„æ•°æ®åº”è¯¥ < 100KB
   - å¦‚æœä»ç„¶ > 50KBï¼Œä¼šè¿›ä¸€æ­¥ç²¾ç®€
   - æœ€ç»ˆæ•°æ®åº”è¯¥ < 50KB

3. **åŠŸèƒ½éªŒè¯**ï¼š
   - EChartsAgent åº”è¯¥èƒ½å¤Ÿæ­£å¸¸æ¥æ”¶å’Œå¤„ç†æ•°æ®
   - ç”Ÿæˆçš„å›¾è¡¨åº”è¯¥åŒ…å«æ­£ç¡®çš„æ•°æ®
   - ä¸åº”è¯¥å†å‡ºç° "Exceeded limit" é”™è¯¯

## ğŸ¯ æ€»ç»“

**é—®é¢˜æ ¹æº**ï¼š
- æ­¥éª¤4è¿”å›çš„ç»Ÿè®¡æŒ‡æ ‡åŒ…å«äº†å®Œæ•´çš„æ•°æ®ç»“æ„ï¼ˆç›¸å…³æ€§çŸ©é˜µã€å®Œæ•´é¢‘ç‡åˆ†å¸ƒï¼‰
- è¿™äº›æ•°æ®é‡å¯èƒ½éå¸¸å¤§ï¼Œè¶…è¿‡LLMçš„è¾“å…¥é™åˆ¶

**è§£å†³æ–¹æ¡ˆ**ï¼š
- åˆ›å»º `_extract_chart_indicators()` å‡½æ•°ï¼Œåªæå–ç”¨äºç”Ÿæˆå›¾è¡¨çš„å…³é”®æŒ‡æ ‡
- ä¸åŒ…å«ç›¸å…³æ€§çŸ©é˜µã€å®Œæ•´é¢‘ç‡åˆ†å¸ƒç­‰å¤§æ•°æ®
- é™åˆ¶åˆ—æ•°å’Œæ•°æ®é‡
- åœ¨æ­¥éª¤4å’Œæ­¥éª¤8éƒ½è¿›è¡Œç²¾ç®€å¤„ç†

**æ•ˆæœ**ï¼š
- æ•°æ®é‡ä»å¯èƒ½å‡ MBé™ä½åˆ°å‡ KB
- é¿å… "Exceeded limit" é”™è¯¯
- ä¿æŒå›¾è¡¨ç”Ÿæˆçš„åŠŸèƒ½å®Œæ•´æ€§
