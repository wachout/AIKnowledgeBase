# TableFileAgent ç›‘ç£æ™ºèƒ½ä½“å’Œ ECharts æ”¹è¿›æ€»ç»“

## ğŸ¯ æ”¹è¿›ç›®æ ‡

1. **æ­¥éª¤4ï¼ˆæ•°ç†ç»Ÿè®¡æ™ºèƒ½ä½“ï¼‰æ”¹è¿›**ï¼š
   - ä¸ä»…è®¡ç®—ç»Ÿè®¡æŒ‡æ ‡ï¼Œè¿˜è¦ç»“åˆä¸šåŠ¡è¯­ä¹‰ç”Ÿæˆ ECharts ç»“æ„æ•°æ®
   - åŸºäºç»Ÿè®¡æŒ‡æ ‡ï¼ˆä¸æ˜¯åŸå§‹æ•°æ®ï¼‰ç”Ÿæˆ ECharts ç»“æ„
   - æ–¹ä¾¿åç»­æ­¥éª¤ç›´æ¥ä½¿ç”¨

2. **åˆ›å»ºç›‘ç£æ™ºèƒ½ä½“**ï¼š
   - æ ¸å¯¹æ¯ä¸€æ­¥å®æ–½çš„å‡†ç¡®æ€§å’Œåˆç†æ€§
   - ç¡®ä¿å‰åæ™ºèƒ½ä½“å·¥ä½œèƒ½å¥½å¥½åè°ƒ
   - æ£€æŸ¥æ•°æ®ä¼ é€’å’Œæ ¼å¼ä¸€è‡´æ€§

## ğŸ“Š ä¸»è¦ä¿®æ”¹

### 1. ä¿®æ”¹ `StatisticsCalculationAgent`ï¼ˆæ­¥éª¤4ï¼‰

**æ–‡ä»¶**: `src/Agent/TableFileAgent/statistics_calculation_agent.py`

#### æ–°å¢åŠŸèƒ½ï¼š

1. **é›†æˆ EchartsAgent**ï¼š
   ```python
   from Agent.EchartsAgent.echarts_agent import EchartsAgent
   self.echarts_agent = EchartsAgent(llm_instance)
   ```

2. **ä¿®æ”¹ `calculate` æ–¹æ³•**ï¼š
   - æ–°å¢å‚æ•° `file_understanding_result`ï¼ˆç”¨äºä¸šåŠ¡è¯­ä¹‰ï¼‰
   - è¿”å›ç»“æœä¸­æ–°å¢ `echarts_structures` å­—æ®µ
   - åœ¨è®¡ç®—ç»Ÿè®¡æŒ‡æ ‡åï¼Œè‡ªåŠ¨ç”Ÿæˆ ECharts ç»“æ„

3. **æ–°å¢ `_generate_echarts_from_indicators` æ–¹æ³•**ï¼š
   - **åªä¼ é€’ç»Ÿè®¡æŒ‡æ ‡**ï¼Œä¸ä¼ é€’åŸå§‹æ•°æ®
   - ç»“åˆä¸šåŠ¡è¯­ä¹‰ç”Ÿæˆ ECharts ç»“æ„
   - æ”¯æŒæè¿°æ€§ç»Ÿè®¡ã€ç›¸å…³æ€§åˆ†æã€é¢‘ç‡åˆ†æç­‰

4. **æ–°å¢è¾…åŠ©æ–¹æ³•**ï¼š
   - `_simplify_indicators()`: ç²¾ç®€ç»Ÿè®¡æŒ‡æ ‡ï¼Œé¿å…æ•°æ®è¿‡å¤§
   - `_extract_business_context()`: æå–ä¸šåŠ¡è¯­ä¹‰ä¸Šä¸‹æ–‡

#### è¾“å‡ºæ ¼å¼ï¼š

```python
{
    "calculations": {
        "Sheet1": {
            "descriptive_statistics": {...},
            "correlation_analysis": {...},
            ...
        }
    },
    "echarts_structures": {  # æ–°å¢
        "Sheet1": [
            {
                "type": "descriptive_statistics",
                "chart_type": "bar",
                "title": "Sheet1 - æè¿°æ€§ç»Ÿè®¡",
                "echarts_config": {...}
            },
            ...
        ]
    }
}
```

### 2. åˆ›å»º `SupervisionAgent`ï¼ˆç›‘ç£æ™ºèƒ½ä½“ï¼‰

**æ–‡ä»¶**: `src/Agent/TableFileAgent/supervision_agent.py`

#### æ ¸å¿ƒåŠŸèƒ½ï¼š

1. **`supervise_step()` æ–¹æ³•**ï¼š
   - è¯„ä¼°æ­¥éª¤çš„å‡†ç¡®æ€§ã€åˆç†æ€§ã€åè°ƒæ€§ã€è´¨é‡
   - ä½¿ç”¨ LLM è¿›è¡Œæ™ºèƒ½è¯„ä¼°
   - è¿”å›ç»“æ„åŒ–çš„è¯„ä¼°ç»“æœ

2. **è¯„ä¼°ç»´åº¦**ï¼š
   - **å‡†ç¡®æ€§**ï¼šæ­¥éª¤ç»“æœæ˜¯å¦ç¬¦åˆé¢„æœŸæ ¼å¼ï¼Œæ˜¯å¦åŒ…å«å¿…è¦æ•°æ®
   - **åˆç†æ€§**ï¼šæ­¥éª¤ç»“æœæ˜¯å¦ä¸å‰ç½®æ­¥éª¤ä¸€è‡´ï¼Œæ•°æ®ä¼ é€’æ˜¯å¦åˆç†
   - **åè°ƒæ€§**ï¼šå½“å‰æ­¥éª¤è¾“å‡ºæ˜¯å¦æ»¡è¶³åç»­æ­¥éª¤çš„è¾“å…¥è¦æ±‚
   - **è´¨é‡**ï¼šæ­¥éª¤ç»“æœçš„è´¨é‡è¯„ä¼°å’Œæ”¹è¿›å»ºè®®

3. **`check_coordination()` æ–¹æ³•**ï¼š
   - æ£€æŸ¥å½“å‰æ­¥éª¤ç»“æœæ˜¯å¦æ»¡è¶³ä¸‹ä¸€æ­¥éª¤çš„è¦æ±‚
   - æ£€æŸ¥å¿…éœ€å­—æ®µæ˜¯å¦å­˜åœ¨
   - æ£€æŸ¥æ•°æ®æ ¼å¼æ˜¯å¦åŒ¹é…

#### è¯„ä¼°ç»“æœæ ¼å¼ï¼š

```python
{
    "accuracy": {
        "score": 0.0-1.0,
        "is_valid": true/false,
        "issues": ["é—®é¢˜1", "é—®é¢˜2"],
        "details": "è¯¦ç»†è¯´æ˜"
    },
    "reasonableness": {
        "score": 0.0-1.0,
        "is_reasonable": true/false,
        "issues": ["é—®é¢˜1", "é—®é¢˜2"],
        "details": "è¯¦ç»†è¯´æ˜"
    },
    "coordination": {
        "score": 0.0-1.0,
        "is_coordinated": true/false,
        "issues": ["é—®é¢˜1", "é—®é¢˜2"],
        "details": "è¯¦ç»†è¯´æ˜",
        "next_step_requirements": {
            "required_fields": ["å­—æ®µ1", "å­—æ®µ2"],
            "data_format": "æ ¼å¼è¯´æ˜",
            "is_ready": true/false
        }
    },
    "quality": {
        "score": 0.0-1.0,
        "assessment": "è´¨é‡è¯„ä¼°",
        "recommendations": ["å»ºè®®1", "å»ºè®®2"]
    },
    "overall": {
        "score": 0.0-1.0,
        "status": "pass/warning/fail",
        "summary": "æ€»ä½“è¯„ä¼°æ‘˜è¦",
        "action_required": true/false,
        "action_items": ["éœ€è¦é‡‡å–çš„è¡ŒåŠ¨1", "éœ€è¦é‡‡å–çš„è¡ŒåŠ¨2"]
    }
}
```

### 3. ä¿®æ”¹ `file_analysis_agent.py`

#### é›†æˆç›‘ç£æ™ºèƒ½ä½“ï¼š

1. **å¯¼å…¥ç›‘ç£æ™ºèƒ½ä½“**ï¼š
   ```python
   from .supervision_agent import SupervisionAgent
   supervision_agent = SupervisionAgent()
   ```

2. **æ·»åŠ ç›‘ç£æ£€æŸ¥å‡½æ•°**ï¼š
   ```python
   def _supervise_step(step_name, step_result, previous_steps, task_context):
       # è°ƒç”¨ç›‘ç£æ™ºèƒ½ä½“è¿›è¡Œè¯„ä¼°
       # è®°å½•ç›‘ç£ç»“æœ
       # å¦‚æœå‘ç°é—®é¢˜ï¼Œè®°å½•è­¦å‘Šæˆ–é”™è¯¯
   ```

3. **åœ¨æ¯ä¸ªæ­¥éª¤åè°ƒç”¨ç›‘ç£æ£€æŸ¥**ï¼š
   - æ­¥éª¤1ï¼ˆæ–‡ä»¶ç†è§£ï¼‰å
   - æ­¥éª¤2ï¼ˆæ•°æ®ç±»å‹åˆ†æï¼‰å
   - æ­¥éª¤3ï¼ˆç»Ÿè®¡è§„åˆ’ï¼‰å
   - æ­¥éª¤4ï¼ˆç»Ÿè®¡è®¡ç®—ï¼‰å
   - æ­¥éª¤5ï¼ˆå…³è”åˆ†æï¼‰å
   - æ­¥éª¤6ï¼ˆè¯­ä¹‰åˆ†æï¼‰å
   - æ­¥éª¤8ï¼ˆEChartsç”Ÿæˆï¼‰å

4. **æ­¥éª¤4æ”¹è¿›**ï¼š
   - ä¼ é€’ `file_understanding_result` ç»™ç»Ÿè®¡è®¡ç®—æ™ºèƒ½ä½“
   - æ£€æŸ¥æ˜¯å¦ç”Ÿæˆäº† ECharts ç»“æ„
   - è®°å½•ç”Ÿæˆçš„ ECharts ç»“æ„æ•°é‡

5. **æ­¥éª¤8æ”¹è¿›**ï¼š
   - **ä¼˜å…ˆä½¿ç”¨æ­¥éª¤4ç”Ÿæˆçš„ ECharts ç»“æ„**
   - é¿å…é‡å¤ç”Ÿæˆå·²å­˜åœ¨çš„å›¾è¡¨
   - å¦‚æœæ­¥éª¤4å·²ç”Ÿæˆï¼Œè·³è¿‡åç»­ç”Ÿæˆé€»è¾‘

## ğŸ”„ å·¥ä½œæµç¨‹æ”¹è¿›

### ä¿®æ”¹å‰ï¼š

```
æ­¥éª¤4: ç»Ÿè®¡è®¡ç®— â†’ è¿”å›åŸå§‹ç»Ÿè®¡æŒ‡æ ‡
  â†“
æ­¥éª¤8: ä½¿ç”¨åŸå§‹æ•°æ®ç”Ÿæˆ EChartsï¼ˆæ•°æ®é‡å¤§ï¼Œæ•ˆç‡ä½ï¼‰
```

### ä¿®æ”¹åï¼š

```
æ­¥éª¤4: ç»Ÿè®¡è®¡ç®— 
  â”œâ”€> è®¡ç®—ç»Ÿè®¡æŒ‡æ ‡
  â””â”€> åŸºäºç»Ÿè®¡æŒ‡æ ‡ + ä¸šåŠ¡è¯­ä¹‰ â†’ ç”Ÿæˆ ECharts ç»“æ„ â­
  â†“
æ­¥éª¤8: 
  â”œâ”€> ä¼˜å…ˆä½¿ç”¨æ­¥éª¤4ç”Ÿæˆçš„ ECharts ç»“æ„ âœ…
  â””â”€> å¦‚æœç¼ºå¤±ï¼Œæ‰ä½¿ç”¨åŸå§‹æ•°æ®ç”Ÿæˆï¼ˆå¤‡ç”¨æ–¹æ¡ˆï¼‰
```

## ğŸ“ˆ å…³é”®æ”¹è¿›ç‚¹

### 1. **åŸºäºæŒ‡æ ‡ç”Ÿæˆï¼Œä¸æ˜¯åŸå§‹æ•°æ®**

**ä¼˜åŠ¿**ï¼š
- âœ… æ•°æ®é‡å°ï¼Œæ•ˆç‡é«˜
- âœ… èšç„¦ç»Ÿè®¡æŒ‡æ ‡ï¼Œæ›´ç²¾å‡†
- âœ… ç»“åˆä¸šåŠ¡è¯­ä¹‰ï¼Œæ›´æ™ºèƒ½

**å®ç°**ï¼š
```python
# åªä¼ é€’ç»Ÿè®¡æŒ‡æ ‡
indicators_str = json.dumps(statistics_indicators, ensure_ascii=False, default=str)

# ç»“åˆä¸šåŠ¡è¯­ä¹‰
business_context = self._extract_business_context(...)
query = f"åŸºäºæè¿°æ€§ç»Ÿè®¡æŒ‡æ ‡ç”Ÿæˆå›¾è¡¨...ä¸šåŠ¡èƒŒæ™¯ï¼š{business_context}"

# ç”Ÿæˆ ECharts ç»“æ„
echarts_result = self.echarts_agent.generate_echarts_config(indicators_str, query)
```

### 2. **ç›‘ç£æ£€æŸ¥æœºåˆ¶**

**æ£€æŸ¥ç‚¹**ï¼š
- âœ… æ­¥éª¤ç»“æœæ ¼å¼æ˜¯å¦æ­£ç¡®
- âœ… å¿…éœ€å­—æ®µæ˜¯å¦å­˜åœ¨
- âœ… æ•°æ®æ˜¯å¦ä¸ºç©º
- âœ… å‰åæ­¥éª¤æ•°æ®ä¼ é€’æ˜¯å¦ä¸€è‡´
- âœ… æ˜¯å¦æ»¡è¶³åç»­æ­¥éª¤çš„è¾“å…¥è¦æ±‚

**ä½œç”¨**ï¼š
- ğŸ¯ åŠæ—¶å‘ç°é—®é¢˜å’Œé”™è¯¯
- ğŸ¯ ç¡®ä¿æ•°æ®ä¼ é€’çš„å‡†ç¡®æ€§
- ğŸ¯ æé«˜æ™ºèƒ½ä½“ä¹‹é—´çš„åè°ƒæ€§
- ğŸ¯ æä¾›æ”¹è¿›å»ºè®®

### 3. **é¿å…é‡å¤ç”Ÿæˆ**

**é€»è¾‘**ï¼š
```python
# æ­¥éª¤8ä¼˜å…ˆä½¿ç”¨æ­¥éª¤4ç”Ÿæˆçš„ ECharts ç»“æ„
echarts_structures = statistics_result.get("echarts_structures", {})
if echarts_structures:
    # ç›´æ¥ä½¿ç”¨ï¼Œä¸é‡å¤ç”Ÿæˆ
    charts.extend(echarts_structures)

# æ£€æŸ¥å·²å­˜åœ¨çš„å›¾è¡¨æ ‡é¢˜
existing_titles = {chart.get("title", "") for chart in charts}

# å¦‚æœå·²å­˜åœ¨ï¼Œè·³è¿‡
if chart_title in existing_titles:
    continue
```

## ğŸ¯ ç›‘ç£æ™ºèƒ½ä½“çš„åè°ƒæ€§æ£€æŸ¥

### æ£€æŸ¥å‰åæ­¥éª¤çš„åè°ƒæ€§ï¼š

1. **æ•°æ®æ ¼å¼ä¸€è‡´æ€§**ï¼š
   - æ£€æŸ¥å½“å‰æ­¥éª¤è¾“å‡ºçš„æ ¼å¼æ˜¯å¦ç¬¦åˆåç»­æ­¥éª¤çš„æœŸæœ›
   - æ£€æŸ¥å­—æ®µåç§°å’Œç»“æ„æ˜¯å¦åŒ¹é…

2. **æ•°æ®å®Œæ•´æ€§**ï¼š
   - æ£€æŸ¥å¿…éœ€å­—æ®µæ˜¯å¦å­˜åœ¨
   - æ£€æŸ¥æ•°æ®æ˜¯å¦ä¸ºç©ºæˆ–ç¼ºå¤±

3. **ä¾èµ–å…³ç³»**ï¼š
   - æ£€æŸ¥å‰ç½®æ­¥éª¤æ˜¯å¦æˆåŠŸå®Œæˆ
   - æ£€æŸ¥å‰ç½®æ­¥éª¤çš„è¾“å‡ºæ˜¯å¦æ»¡è¶³å½“å‰æ­¥éª¤çš„è¦æ±‚

4. **ä¸šåŠ¡é€»è¾‘ä¸€è‡´æ€§**ï¼š
   - æ£€æŸ¥æ­¥éª¤ç»“æœæ˜¯å¦ä¸ä¸šåŠ¡ç›®æ ‡ä¸€è‡´
   - æ£€æŸ¥æ•°æ®ä¼ é€’æ˜¯å¦ç¬¦åˆä¸šåŠ¡é€»è¾‘

## ğŸ“ ä½¿ç”¨ç¤ºä¾‹

### æ­¥éª¤4ç”Ÿæˆ ECharts ç»“æ„ï¼š

```python
# åœ¨ StatisticsCalculationAgent.calculate() ä¸­
statistics_result = {
    "calculations": {
        "Sheet1": {
            "descriptive_statistics": {...},
            "correlation_analysis": {...}
        }
    },
    "echarts_structures": {  # è‡ªåŠ¨ç”Ÿæˆ
        "Sheet1": [
            {
                "type": "descriptive_statistics",
                "chart_type": "bar",
                "title": "Sheet1 - æè¿°æ€§ç»Ÿè®¡",
                "echarts_config": {
                    "title": {"text": "Sheet1 - æè¿°æ€§ç»Ÿè®¡"},
                    "xAxis": {"type": "category", "data": [...]},
                    "yAxis": {"type": "value"},
                    "series": [{"type": "bar", "data": [...]}]
                }
            }
        ]
    }
}
```

### ç›‘ç£æ£€æŸ¥ï¼š

```python
# åœ¨æ¯ä¸ªæ­¥éª¤å
supervision_result = supervision_agent.supervise_step(
    step_name="statistics_calculation",
    step_result=statistics_result,
    previous_steps=step_results,
    task_context=task_context
)

# æ£€æŸ¥ç»“æœ
if supervision_result.get("overall", {}).get("status") == "fail":
    logger.error("æ­¥éª¤æ‰§è¡Œå¤±è´¥ï¼Œéœ€è¦ä¿®å¤")
elif supervision_result.get("overall", {}).get("status") == "warning":
    logger.warning("æ­¥éª¤æ‰§è¡Œæœ‰è­¦å‘Šï¼Œå»ºè®®æ£€æŸ¥")
```

## âœ… ä¼˜åŠ¿æ€»ç»“

1. **æ•ˆç‡æå‡**ï¼š
   - åŸºäºç»Ÿè®¡æŒ‡æ ‡ç”Ÿæˆï¼Œæ•°æ®é‡å°
   - é¿å…é‡å¤ç”Ÿæˆå›¾è¡¨
   - æå‰ç”Ÿæˆï¼Œå‡å°‘æ­¥éª¤8çš„è´Ÿæ‹…

2. **è´¨é‡æå‡**ï¼š
   - ç»“åˆä¸šåŠ¡è¯­ä¹‰ï¼Œæ›´æ™ºèƒ½
   - ç›‘ç£æ£€æŸ¥ç¡®ä¿å‡†ç¡®æ€§
   - åè°ƒæ€§æ£€æŸ¥ç¡®ä¿ä¸€è‡´æ€§

3. **å¯ç»´æŠ¤æ€§**ï¼š
   - ç›‘ç£ç»“æœæä¾›è¯¦ç»†çš„é—®é¢˜å’Œå»ºè®®
   - ä¾¿äºè°ƒè¯•å’Œä¼˜åŒ–
   - ç¡®ä¿æ™ºèƒ½ä½“ä¹‹é—´çš„åè°ƒå·¥ä½œ

4. **ç”¨æˆ·ä½“éªŒ**ï¼š
   - æ›´å¿«çš„å“åº”é€Ÿåº¦
   - æ›´å‡†ç¡®çš„å›¾è¡¨ç”Ÿæˆ
   - æ›´å¥½çš„é”™è¯¯æç¤º

## ğŸ” æ³¨æ„äº‹é¡¹

1. **æ•°æ®å¤§å°é™åˆ¶**ï¼š
   - å¦‚æœç»Ÿè®¡æŒ‡æ ‡å¤ªå¤§ï¼Œä¼šè‡ªåŠ¨ç²¾ç®€
   - åªä¿ç•™å…³é”®ç»Ÿè®¡ä¿¡æ¯

2. **é”™è¯¯å¤„ç†**ï¼š
   - å¦‚æœ ECharts ç”Ÿæˆå¤±è´¥ï¼Œä¸å½±å“ç»Ÿè®¡è®¡ç®—
   - æ­¥éª¤8ä¼šä½¿ç”¨å¤‡ç”¨æ–¹æ¡ˆ

3. **ç›‘ç£æ£€æŸ¥**ï¼š
   - å¦‚æœ LLM è¯„ä¼°å¤±è´¥ï¼Œä¼šä½¿ç”¨åŸºç¡€æ£€æŸ¥
   - ä¸ä¼šé˜»å¡ä¸»æµç¨‹

4. **æ€§èƒ½è€ƒè™‘**ï¼š
   - ç›‘ç£æ£€æŸ¥ä½¿ç”¨ LLMï¼Œå¯èƒ½å¢åŠ å»¶è¿Ÿ
   - å¯ä»¥é€šè¿‡é…ç½®æ§åˆ¶æ˜¯å¦å¯ç”¨è¯¦ç»†æ£€æŸ¥
